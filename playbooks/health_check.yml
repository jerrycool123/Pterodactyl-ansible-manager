- name: Health Check
  hosts: myhost
  tasks:
    - name: Read containers
      ansible.builtin.include_vars: ../containers/container.yml
    - name: Get container ids
      ansible.builtin.command: docker ps -aqf "name=""{{ item.key }}"
      register: container_ids
      with_dict: "{{ containers }}"
      loop_control:
        label: "{{ item.value }}"
    - name: Check if container exists
      ansible.builtin.assert:
        that: item.stdout != ""
        fail_msg: "Container '{{ item.item.key }}': '{{ item.item.value }}' not found."
        quiet: true
      with_items: "{{ container_ids.results }}"
      loop_control:
        label: "{{ item.item.value }}"
    - name: Get container states
      ansible.builtin.command: docker inspect --format '{{ '{{' }} .State.Status {{ '}}' }}' "{{ item.stdout }}"
      register: container_states
      with_items: "{{ container_ids.results }}"
      loop_control:
        label: "{{ item.item.value }}"
    - name: Print container states
      set_fact:
        output: "{{ output | default({}) | combine({ item.item.item.value : item.stdout }) }}"
      with_items: "{{ container_states.results }}"
      loop_control:
        label: "{{ item.item.item.value }}"
    - name: Write to state.json
      ansible.builtin.copy:
        content: "{{ output | to_nice_json(indent=2) }}"
        dest: "{{ lookup('env', 'PWD') }}/state.json"
